{#
ImageGallery Component

Parameters:
- layout: string (optional) - 'grid' | 'masonry' | 'horizontal' | 'auto' | 'mixed', default: 'auto'
- columns: number (optional) - 2 | 3 | 4, default: 3
- background: string (optional) - 'white' | 'soft' | 'transparent' | 'accent' | 'dark', default: 'transparent'
- gap: string (optional) - 'small' | 'medium' | 'large', default: 'medium'
- rounded: boolean (optional) - default: true
- svgVariant: number|string (optional) - 1 | 2 | 3 | 'none', default: 'none'
#}

{% set images = entry.images.all() ?? [] %}
{% set layout = entry.layout.value ?? 'auto' %}
{% set columns = entry.columns.value ?? 3 %}
{% set background = entry.backgroundColor.value ?? entry.backgroundColor ?? 'transparent' %}
{% set gap = entry.gap.value ?? 'medium' %}
{% set rounded = entry.rounded ?? true %}
{% set svgVariant = entry.svgVariant ?? 1 %}

{# Default-Werte #}
{% set backgroundClass = '' %}
{% set svgColor1 = 'text-brand-secondary/8' %}
{% set svgColor2 = 'text-brand-accent/10' %}
{% set svgColor3 = 'text-brand-primary/12' %}
{% set svgColor4 = 'text-brand-accent/15' %}

{# Background-spezifische Überschreibungen #}
{% if background == 'soft' %}
    {% set backgroundClass = 'bg-background-soft' %}
{% elseif background == 'white' %}
    {% set backgroundClass = 'bg-white' %}
{% elseif background == 'accent' %}
    {% set backgroundClass = 'bg-brand-accent' %}
{% elseif background in ['blue', 'orange'] %}
    {% set backgroundClass = background == 'blue' ? 'bg-brand-primary' : 'bg-brand-secondary' %}
    {% set svgColor1 = 'text-white/8' %}
    {% set svgColor2 = 'text-white/10' %}
    {% set svgColor3 = 'text-white/12' %}
    {% set svgColor4 = 'text-white/15' %}
{% endif %}

{% set gapClass = gap == 'small' ? 'gap-4'
    : gap == 'medium' ? 'gap-6'
    : 'gap-8' %}

{% set imageCount = images|length %}

{% if imageCount == 0 %}
    {# No images to display #}
{% else %}

{% set autoColumns = imageCount == 1 ? 1
    : imageCount == 2 ? 2
    : imageCount == 3 ? 3
    : imageCount == 4 ? 4
    : min(imageCount, columns) %}

{% set effectiveColumns = layout == 'auto' ? autoColumns : columns %}

{% set columnClass = effectiveColumns == 1 ? 'md:grid-cols-1'
    : effectiveColumns == 2 ? 'md:grid-cols-2'
    : effectiveColumns == 3 ? 'md:grid-cols-2 lg:grid-cols-3'
    : 'md:grid-cols-2 lg:grid-cols-4' %}

{% set roundedClass = rounded ? 'rounded-2xl' : '' %}

{% set imageWidth = 800 %}
{% set imageHeight = 600 %}

{% set transform = {
    format: 'webp',
    quality: 85,
    width: imageWidth,
    height: imageHeight,
    mode: 'crop'
} %}

<section class="py-16 relative {{ backgroundClass }}">
    {# SVG Background Shapes #}
    {% include '_partials/svg-shapes.twig' with {
        variant: svgVariant,
        color1: svgColor1,
        color2: svgColor2,
        color3: svgColor3,
        color4: svgColor4
    } %}

    <div class="max-w-7xl mx-auto px-4 lg:px-8 relative z-10">
        {% if layout == 'grid' or layout == 'auto' %}
            <div class="grid grid-cols-1 {{ columnClass }} {{ gapClass }}">
                {% for image in images %}
                    <div class="overflow-hidden {{ roundedClass }} shadow-soft hover:shadow-elevated transition-all duration-300 hover:scale-105">
                        {{ tag('img', {
                            class: 'w-full h-64 object-cover',
                            width: imageWidth,
                            height: imageHeight,
                            src: image.getUrl(transform),
                            alt: image.title
                        }) }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% if layout == 'masonry' %}
            <div class="columns-1 md:columns-2 lg:columns-{{ columns }} {{ gapClass }}">
                {% for image in images %}
                    {% set mbClass = gap == 'small' ? 'mb-4' : gap == 'medium' ? 'mb-6' : 'mb-8' %}
                    <div class="{{ mbClass }} break-inside-avoid">
                        <div class="overflow-hidden {{ roundedClass }} shadow-soft hover:shadow-elevated transition-all duration-300 hover:scale-105">
                            {{ tag('img', {
                                class: 'w-full h-auto object-cover',
                                src: image.getUrl({ format: 'webp', quality: 85, width: 800 }),
                                alt: image.title
                            }) }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% if layout == 'horizontal' %}
            <div class="relative" data-gallery-id="{{ random() }}" role="region" aria-label="Bildergalerie" aria-live="polite">
                <div class="relative group">
                    {# Navigation Buttons - positioned relative to image height #}
                    <button
                        class="gallery-nav-prev absolute left-4 top-32 -translate-y-1/2 z-20 bg-white/90 hover:bg-white focus:bg-white text-brand-primary rounded-full p-3 shadow-lg opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity duration-300 cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:ring-offset-2"
                        onclick="navigateGallery(this, -1)"
                        aria-label="Vorheriges Bild anzeigen"
                        tabindex="0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>

                    <button
                        class="gallery-nav-next absolute right-4 top-32 -translate-y-1/2 z-20 bg-white/90 hover:bg-white focus:bg-white text-brand-primary rounded-full p-3 shadow-lg opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity duration-300 cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:ring-offset-2"
                        onclick="navigateGallery(this, 1)"
                        aria-label="Nächstes Bild anzeigen"
                        tabindex="0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>

                    {# Live region for screen readers #}
                    <div class="sr-only" aria-live="polite" aria-atomic="true" role="status">
                        <span class="gallery-status">Bild <span class="current-slide">1</span> von <span class="total-slides">{{ imageCount }}</span></span>
                    </div>

                    {# Scrollable Images #}
                    <div class="flex overflow-x-auto {{ gapClass }} pb-4 scrollbar-hide snap-x snap-mandatory horizontal-scroll"
                         role="list"
                         tabindex="0"
                         aria-label="Bilder in der Galerie">
                        {% for image in images %}
                            <div class="flex-shrink-0 w-80 snap-start" role="listitem">
                                <div class="overflow-hidden {{ roundedClass }} shadow-soft hover:shadow-elevated transition-all duration-300 hover:scale-105 focus-within:ring-2 focus-within:ring-brand-secondary">
                                    {{ tag('img', {
                                        class: 'w-full h-64 object-cover',
                                        width: imageWidth,
                                        height: imageHeight,
                                        src: image.getUrl(transform),
                                        alt: image.title ? image.title : 'Galeriebild ' ~ (loop.index),
                                        tabindex: '0'
                                    }) }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                {# Interactive Scroll Indicator Dots #}
                <div class="flex justify-center gap-2 mt-4 dots-container" role="tablist" aria-label="Galerie Navigation">
                    {# Dots will be dynamically shown/hidden based on reachability #}
                    {% for i in 0..(imageCount - 1) %}
                        <button
                            class="w-2 h-2 rounded-full {% if background in ['blue', 'orange'] %}bg-white opacity-40{% else %}bg-gray-300 opacity-50{% endif %} hover:opacity-75 focus:opacity-100 transition-all duration-300 cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-secondary focus:ring-offset-2 dot"
                            data-index="{{ i }}"
                            onclick="scrollToImage(this, {{ i }})"
                            role="tab"
                            aria-label="Zu Bild {{ i + 1 }} springen"
                            aria-selected="false"
                            tabindex="-1">
                        </button>
                    {% endfor %}
                </div>
            </div>

            <script>
            const galleryStates = new Map();

            function getGalleryState(galleryId) {
                if (!galleryStates.has(galleryId)) {
                    galleryStates.set(galleryId, { isScrolling: false, scrollTimeout: null });
                }
                return galleryStates.get(galleryId);
            }

            function navigateGallery(button, direction) {
                const galleryContainer = button.closest('[data-gallery-id]');
                const galleryId = galleryContainer.dataset.galleryId;
                const state = getGalleryState(galleryId);

                if (state.isScrolling) {
                    console.log('Already scrolling, ignoring click');
                    return;
                }

                const container = galleryContainer.querySelector('.horizontal-scroll');
                const items = container.querySelectorAll('.snap-start');
                const scrollLeft = container.scrollLeft;
                const maxScrollLeft = container.scrollWidth - container.clientWidth;

                // Find currently visible item based on scroll position
                let currentIndex = 0;
                let minDistance = Infinity;
                items.forEach((item, index) => {
                    const distance = Math.abs(item.offsetLeft - scrollLeft);
                    if (distance < minDistance) {
                        minDistance = distance;
                        currentIndex = index;
                    }
                });

                console.log('Before adjustment - currentIndex:', currentIndex, 'scrollLeft:', scrollLeft, 'maxScrollLeft:', maxScrollLeft);

                // Calculate next index with wrapping
                let nextIndex = currentIndex + direction;

                // Check if target position is beyond max scroll (items not reachable)
                // For snap-start, we need to check if we can scroll to make the item visible at the left edge
                if (nextIndex >= 0 && nextIndex < items.length) {
                    const targetOffsetLeft = items[nextIndex].offsetLeft;
                    // Item is reachable if its left edge position is <= maxScrollLeft
                    if (targetOffsetLeft > maxScrollLeft && direction === 1) {
                        // Can't scroll there, we're at the last visible item - wrap to beginning
                        console.log('Target item', nextIndex, 'at position', targetOffsetLeft, 'is beyond max scroll', maxScrollLeft, '- wrapping to 0');
                        nextIndex = 0;
                    }
                }

                // Handle wrapping at boundaries
                if (nextIndex < 0) {
                    nextIndex = items.length - 1;
                } else if (nextIndex >= items.length) {
                    nextIndex = 0;
                }

                state.isScrolling = true;
                console.log('Navigating from', currentIndex, 'to', nextIndex, '(total:', items.length, ')');

                // Scroll to the next item
                const targetItem = items[nextIndex];
                const targetScrollLeft = targetItem.offsetLeft;

                console.log('Target scroll:', targetScrollLeft, 'Max scroll:', maxScrollLeft);

                // If we're wrapping around, do it instantly
                if ((currentIndex === items.length - 1 && direction === 1) || (currentIndex === 0 && direction === -1)) {
                    console.log('Wrapping to', nextIndex);
                    container.scrollTo({left: targetScrollLeft, behavior: 'auto'});
                } else {
                    container.scrollTo({left: targetScrollLeft, behavior: 'smooth'});
                }

                // Clear any existing timeout
                if (state.scrollTimeout) {
                    clearTimeout(state.scrollTimeout);
                }

                // Reset after animation completes
                state.scrollTimeout = setTimeout(() => {
                    state.isScrolling = false;
                    console.log('Scroll complete, unlocked');
                    updateNavButtons(container);
                }, 800);
            }

            function scrollToImage(button, index) {
                const galleryContainer = button.closest('[data-gallery-id]');
                const galleryId = galleryContainer.dataset.galleryId;
                const state = getGalleryState(galleryId);

                if (state.isScrolling) return;

                const container = galleryContainer.querySelector('.horizontal-scroll');
                const items = container.querySelectorAll('.snap-start');

                state.isScrolling = true;

                const targetItem = items[index];
                container.scrollTo({left: targetItem.offsetLeft, behavior: 'smooth'});

                if (state.scrollTimeout) {
                    clearTimeout(state.scrollTimeout);
                }

                state.scrollTimeout = setTimeout(() => {
                    state.isScrolling = false;
                    updateNavButtons(container);
                }, 800);
            }

            function updateNavButtons(scrollContainer) {
                const galleryContainer = scrollContainer.closest('[data-gallery-id]');
                const items = scrollContainer.querySelectorAll('.snap-start');
                const scrollLeft = scrollContainer.scrollLeft;
                const maxScrollLeft = scrollContainer.scrollWidth - scrollContainer.clientWidth;

                // Find current index based on scroll position
                let currentIndex = 0;
                let minDistance = Infinity;
                items.forEach((item, index) => {
                    const distance = Math.abs(item.offsetLeft - scrollLeft);
                    if (distance < minDistance) {
                        minDistance = distance;
                        currentIndex = index;
                    }
                });

                console.log('Current index:', currentIndex, 'of', items.length, '(scrollLeft:', scrollLeft, ')');

                // Update live region for screen readers
                const currentSlideSpan = galleryContainer.querySelector('.current-slide');
                if (currentSlideSpan) {
                    currentSlideSpan.textContent = currentIndex + 1;
                }

                // Update dots
                const dots = galleryContainer.querySelectorAll('.dot');
                const isDarkBg = galleryContainer.closest('section').classList.contains('bg-brand-primary') ||
                                 galleryContainer.closest('section').classList.contains('bg-brand-secondary');

                dots.forEach((dot, index) => {
                    // Check if this item is reachable
                    const item = items[index];
                    const isReachable = item && item.offsetLeft <= maxScrollLeft;

                    if (!isReachable) {
                        // Hide unreachable dots
                        dot.style.display = 'none';
                        dot.setAttribute('aria-hidden', 'true');
                        dot.setAttribute('tabindex', '-1');
                    } else {
                        dot.style.display = 'block';
                        dot.setAttribute('aria-hidden', 'false');

                        if (index === currentIndex) {
                            dot.classList.remove('bg-gray-300', 'bg-white', 'w-2', 'h-2', 'opacity-50', 'opacity-40');
                            dot.setAttribute('aria-selected', 'true');
                            dot.setAttribute('tabindex', '0');
                            if (isDarkBg) {
                                dot.classList.add('bg-white', 'w-10', 'h-3', 'opacity-100');
                            } else {
                                dot.classList.add('bg-brand-primary', 'w-10', 'h-3', 'opacity-100');
                            }
                        } else {
                            dot.classList.remove('bg-brand-primary', 'bg-white', 'w-10', 'h-3', 'opacity-100');
                            dot.setAttribute('aria-selected', 'false');
                            dot.setAttribute('tabindex', '-1');
                            if (isDarkBg) {
                                dot.classList.add('bg-white', 'w-2', 'h-2', 'opacity-40');
                            } else {
                                dot.classList.add('bg-gray-300', 'w-2', 'h-2', 'opacity-50');
                            }
                        }
                    }
                });
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.horizontal-scroll').forEach(container => {
                    const galleryContainer = container.closest('[data-gallery-id]');
                    const galleryId = galleryContainer.dataset.galleryId;
                    const state = getGalleryState(galleryId);

                    // Scroll to first item initially to ensure proper alignment
                    const items = container.querySelectorAll('.snap-start');
                    if (items.length > 0) {
                        // Simply scroll to the very beginning
                        container.scrollTo({left: 0, behavior: 'auto'});
                        console.log('Initial scroll to position 0');
                    }

                    // Update nav buttons after initial scroll
                    setTimeout(() => {
                        updateNavButtons(container);
                    }, 100);

                    container.addEventListener('scroll', function() {
                        if (state.scrollTimeout) {
                            clearTimeout(state.scrollTimeout);
                        }

                        state.scrollTimeout = setTimeout(() => {
                            updateNavButtons(this);
                        }, 150);
                    });

                    // Failsafe: Reset scrolling state after any scroll ends
                    container.addEventListener('scrollend', function() {
                        state.isScrolling = false;
                        console.log('Scrollend event - unlocked');
                    });

                    // Handle window resize - recalculate dots visibility
                    let resizeTimeout;
                    window.addEventListener('resize', function() {
                        clearTimeout(resizeTimeout);
                        resizeTimeout = setTimeout(() => {
                            console.log('Window resized, updating dots visibility');
                            updateNavButtons(container);
                        }, 250);
                    });

                    // Keyboard navigation: Arrow keys - works globally when gallery is in viewport
                    const galleryKeyHandler = function(e) {
                        // Check if gallery is visible in viewport
                        const rect = galleryContainer.getBoundingClientRect();
                        const isInViewport = rect.top < window.innerHeight && rect.bottom > 0;

                        if (!isInViewport) return;

                        // Check if user is not typing in an input field
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                        if (e.key === 'ArrowLeft') {
                            e.preventDefault();
                            const prevBtn = galleryContainer.querySelector('.gallery-nav-prev');
                            if (prevBtn) prevBtn.click();
                        } else if (e.key === 'ArrowRight') {
                            e.preventDefault();
                            const nextBtn = galleryContainer.querySelector('.gallery-nav-next');
                            if (nextBtn) nextBtn.click();
                        }
                    };

                    document.addEventListener('keydown', galleryKeyHandler);
                });
            });
            </script>
        {% endif %}

        {% if layout == 'mixed' %}
            <div class="grid grid-cols-1 md:grid-cols-3 {{ gapClass }} mixed-gallery">
                {% for image in images %}
                    {% set isPortrait = image.width < image.height %}
                    <div class="overflow-hidden {{ roundedClass }} shadow-soft hover:shadow-elevated transition-all duration-300 hover:scale-105 {{ isPortrait ? 'portrait-item' : 'landscape-item' }}">
                        {{ tag('img', {
                            class: 'w-full h-full object-cover',
                            src: image.getUrl({ format: 'webp', quality: 85, width: 1200 }),
                            alt: image.title
                        }) }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</section>

{% endif %}

<style>
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .mixed-gallery {
        grid-auto-rows: 350px;
        grid-auto-flow: dense;
    }

    .mixed-gallery .landscape-item {
        grid-column: span 1;
        grid-row: span 1;
    }

    .mixed-gallery .portrait-item {
        grid-column: span 1;
        grid-row: span 1;
    }

    @media (min-width: 768px) {
        .mixed-gallery .landscape-item {
            grid-column: span 2;
        }

        .mixed-gallery .portrait-item {
            grid-column: span 1;
            grid-row: span 2;
        }
    }
</style>